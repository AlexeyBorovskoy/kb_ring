# План Шага 1: Тестовый Контур На Сервере Нила

Дата актуализации: 2026-02-16

Назначение документа: зафиксировать подробный, воспроизводимый и проверяемый план шага 1 без автоматического деплоя. Любые действия на сервере выполняются только после отдельного подтверждения.

## 1. Цель шага 1 (DoD)

Шаг 1 считается завершённым, если выполнены все пункты:
1. Поднят единый домен с общей входной страницей и маршрутизацией по путям.
2. Подняты и доступны:
- `KB-RING` под `/kb`
- `TG web` под `/tg`
- `transcription` под `/transcription`
3. Создана новая БД `kb_ring`.
4. Полный TG дамп восстановлен в `kb_ring` в схему `tg`.
5. Данные из TG и transcription индексируются в `tac.*`.
6. Работают `search` и `rag-tech` с citations.
7. Нагрузка пайплайна ограничена и наблюдаема.

## 2. Зафиксированные вводные

- Целевой путь TG на Ниле: `/opt/tg_digest_system/`.
- Предпочтительный формат миграционного дампа TG: `pg_dump -Fc`.
- В шаге 1 переносим «всё TG» (все таблицы/объекты текущего контура).
- Для subpath:
  - TG: реализуем «как проще» на первом этапе, но с учётом полного плана.
  - transcription: разрешены правки `index.html`.
- OCR на шаге 1 обязателен для вложений; режим обработки последовательный.
- Минимальный набор форматов вложений шага 1: `pdf`, `jpg/png`, `docx`, `txt/md/html`.
- Ресурсный лимит: до ~30% ресурсов сервера.

## 3. Область работ шага 1

### 3.1 Инфраструктура

- Развёртывание compose-контура KB-RING (`postgres + api + worker`).
- Подготовка директорий и конфигов в `/opt/kb-ring` и `/opt/tg_digest_system`.
- Настройка reverse proxy под один домен и subpath.

### 3.2 Данные

- Создание БД `kb_ring`.
- Восстановление TG дампа в схему `tg`.
- Проверка целостности ключевых TG таблиц после восстановления.
- Подготовка ETL-слоя (или materialization scripts) из `tg.*` в `tac.documents`.

### 3.3 Интеграция сервисов

- Подключение transcription к общему JWT.
- Публикация markdown-результатов transcription в ingest endpoint KB-RING.
- Адаптация TG/transcription UI под `subpath`.

### 3.4 Качество и наблюдаемость

- Проверка OCR primary/fallback.
- Проверка retrieval/rerank/RAG поведения.
- Включение базового мониторинга хоста и сервисов.

## 4. Подробный пошаговый план

### Шаг 1. Локальная подготовка и контроль артефактов

1. Проверить локальные скрипты/патчи в `ops/step1_nil/`.
2. Проверить актуальность экспортов в `server_exports/`.
3. Подготовить финальные шаблоны `Caddyfile` и `compose`.
4. Подготовить чеклист smoke-тестов (ниже, раздел 7).

Критерий готовности:
- полный набор артефактов готов локально, сервер используется только для применения.

### Шаг 2. Проверка доступа и среды на Ниле

1. Проверка SSH и путей.
2. Проверка существующего мониторинга (`/opt/monitoring/*`, `/opt/server-docs/*`).
3. Проверка существующего transcription-контурa и портов.

Критерий готовности:
- подтверждён доступ, есть понимание текущего стека и ограничений.

### Шаг 3. Подготовка директорий и секретов

1. Создать/проверить:
- `/opt/kb-ring/`
- `/opt/tg_digest_system/`
2. Заполнить `secrets.env` для сервисов.
3. Убедиться, что секреты не попадают в git.

Критерий готовности:
- файловая структура готова, секреты централизованы.

### Шаг 4. Миграция TG в `kb_ring`

1. Получить/проверить `pg_dump -Fc`.
2. Поднять `postgres(pgvector)` и создать `kb_ring`.
3. Восстановить дамп в `tg` схему.
4. Выполнить пост-проверку количества ключевых сущностей и связей.

Критерий готовности:
- TG данные восстановлены, TG runtime данные/артефакты не потеряны.

### Шаг 5. Поднятие KB-RING

1. Применить схему/миграции KB-RING.
2. Поднять `api` и `worker`.
3. Проверить `health`, очередь jobs и базовую индексацию.

Критерий готовности:
- KB-RING отвечает и способен индексировать документ.

### Шаг 6. Интеграция transcription

1. Подключить JWT.
2. Включить push в `/api/v1/ingest/transcript`.
3. Проверить end-to-end на одной тестовой задаче.

Критерий готовности:
- markdown transcription автоматически становится документом в KB-RING.

### Шаг 7. Subpath-адаптация TG/transcription

1. Применить патч `/transcription` (разрешённые правки фронта).
2. Применить минимальный патч `/tg` (FastAPI root path/статика/ссылки).
3. Проверить UI переходы и API вызовы через обратный прокси.

Критерий готовности:
- оба UI корректно работают под `subpath`.

### Шаг 8. Поиск и RAG проверка

1. Выполнить `search` по данным TG и transcription.
2. Выполнить `rag-tech` запрос и проверить citations.
3. Убедиться, что citations кликабельны и ведут в нужные URI.

Критерий готовности:
- функционал retrieval+RAG валиден.

### Шаг 9. OCR проверка

1. Прогон форматов: `pdf`, `jpg/png`, `docx`, `txt/md/html`.
2. Проверка primary OCR и fallback сценариев.
3. Проверка последовательной загрузки (без параллельного шторма).

Критерий готовности:
- OCR стабилен на целевых форматах.

### Шаг 10. Ограничение ресурсов и мониторинг

1. Выставить docker limits для worker/api.
2. Ограничить параллелизм embeddings/rerank/OCR.
3. Подключить и проверить метрики/алерты уровня “zabbix-like”.

Критерий готовности:
- сервис работает в лимите ресурсов и наблюдаем.

## 5. Конкретные артефакты из репозитория

- `ops/step1_nil/docker-compose.kb_ring.yml`
- `ops/step1_nil/Caddyfile.kb_single_domain.snippet`
- `ops/step1_nil/restore_tg_dump_to_kb_ring.sh`
- `ops/step1_nil/patch_tg_subpath.sh`
- `ops/step1_nil/patch_transcription_subpath.sh`
- `ops/step1_nil/check_server_access.sh`
- `ops/step1_nil/prepare_nil_layout.sh`

## 6. Политика секретов и ротации

- Секреты хранятся только на сервере в `secrets.env` (права `600`).
- На шаге 1 допускаются тестовые ключи только в тестовом контуре.
- Любая ротация фиксируется в ops-журнале.
- Коммиты с реальными ключами запрещены.

## 7. Smoke-тесты шага 1 (обязательные)

1. `auth`: вход через портал, cookie установлен, доступ к `/kb` разрешён.
2. `ingest transcription`: после завершения задачи появляется запись в `tac.documents`.
3. `tg import`: данные доступны в `tg.*`, материализация в `tac.documents` выполняется.
4. `index`: создаются `tac.chunks` и `tac.embeddings`.
5. `search`: есть результаты по обоим источникам.
6. `rag-tech`: ответ с корректными citations.
7. `ocr`: файлы из минимального набора извлекаются успешно.
8. `limits`: во время нагрузки соблюдается ресурсный бюджет.

## 8. Риски шага 1

1. Subpath несовместимость фронта TG/transcription.
- Действие: использовать подготовленные патчи и контроль manual links/fetch.

2. Проблемный cloud OCR (таймауты/квоты).
- Действие: последовательная очередь + fallback + метрики отказов.

3. Неполный импорт TG.
- Действие: контрольные сверки таблиц и ключевых количеств.

4. Пиковая нагрузка при индексации.
- Действие: staged ingest и консервативный параллелизм.

## 9. Что сознательно не делаем на шаге 1

- Полный редизайн TG/transcription.
- Масштабный рефакторинг всех исторических таблиц TG.
- Автоматический продовый cutover без отдельной команды.

## 10. Решение о переходе к деплою

После прохождения smoke-тестов оформляется короткий отчёт:
1. что проверено;
2. что прошло/не прошло;
3. риски на продовом cutover;
4. предложение по следующему шагу.

Только после подтверждения владельца проекта начинается деплой на сервер Нила.
