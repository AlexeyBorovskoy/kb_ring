# Требования к RAG (из документов shared_vm)

Исходники:
- `/home/alexey/shared_vm/запросы по kb.txt`
- `/home/alexey/shared_vm/Ответы системы.txt`

## Обязательные ограничения

- Режим **search-only** должен работать **без** LLM.
- Режим **rag** вызывает ChatGPT/OpenAI **только после** retrieval.
- Запрещено отправлять в LLM целые документы.
- Ограничение контекста: **не более 20 чанков**.
- Если данных недостаточно, ответ должен быть честным: `"данные не найдены"`.
- Каждый RAG-ответ должен возвращать **источники** (citations) и ссылаться на реальные документы/чанки.

## Формат инженерного ответа (обязательный)

Источник требований: `/home/alexey/shared_vm/ответ по коду в gitlab.txt`.

Требование: ответ должен быть ориентирован на инженерную практику и содержать:
- **Резюме** (1–3 абзаца, что найдено и где).
- **Структурированный список** (например, интерфейсы/компоненты/модули), по каждому:
  - назначение;
  - ключевые методы/контракты;
  - пример вызова/команды (если применимо, например `curl`);
  - ссылка на источник (репозиторий/файл/документ).
- **Итог** (что главное, с чего начинать изучение).
- **Источники (обязательно)** в формате списка:
  - `[1] <uri>`
  - `[2] <uri>`

`uri` должен быть максимально конкретным:
- `gitlab://<group>/<repo>/<path>#L<line>` (если известны строки)
- `nextcloud://<path>` (или иной источник)

## API (текущая реализация)

- `POST /api/v1/chat/sessions`
- `GET /api/v1/chat/sessions/{id}`
- `POST /api/v1/chat/sessions/{id}/message` с `mode=search|rag|analysis`

Режимы:
- `search`: retrieval-only, без LLM.
- `rag`: инженерный ответ через LLM строго по источникам + citations.
- `analysis`: отчёт/сводка по выбранным источникам (опционально), также строго по источникам + citations.

## Требования к citations (практика)

- citations должны быть как минимум 1 (если найдено хоть что-то).
- citations должны быть согласованы с нумерацией в контексте: модель ссылается как `[1]`, `[2]`, ... и те же номера возвращаются в JSON.
- `uri` должен быть максимально конкретным. Если канонической ссылки нет, допускается fallback вида `chunk://<chunk_id>`.

## Хранение

- `chat.sessions` / `chat.messages` / `chat.message_citations` / `chat.session_memory`
- citations связывают `assistant` сообщение с `tac.chunks.id`
- `tac.documents.uri` используется как “каноническая ссылка” на источник
