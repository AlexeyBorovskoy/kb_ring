# KB-RING: Сводный План Создания Системы

Дата актуализации: 2026-02-16

Документ фиксирует полный план построения единой системы знаний KB-RING на базе существующих контуров TG Digest и transcription.

## 1. Бизнес-цель и границы

Цель:
- объединить источники знаний (TG + transcription) в один контур поиска и инженерного RAG;
- обеспечить единый вход пользователя;
- сохранить работоспособность существующих сервисов в процессе миграции.

Границы этого плана:
- архитектура, данные, авторизация, деплой, миграция, мониторинг, контроль ресурсов;
- исключая финальный «боевой» cutover без отдельного подтверждения.

## 2. Обязательные архитектурные решения (зафиксировано)

1. Один целевой домен (single FQDN), одна входная web-страница, далее выбор раздела.
2. Доступ сервисов по subpath:
- `/kb`
- `/tg`
- `/transcription`
3. Новая БД `kb_ring` с размещением в ней всех данных TG.
4. TG импортируется из `pg_dump -Fc` в схему `tg` внутри `kb_ring`.
5. На шаге 1 сохраняем работоспособность TG после миграции.
6. transcription на шаге 1 не отключает OpenAI postprocess; версии промптов фиксируются.
7. OCR для вложений TG на шаге 1 обязателен.
8. Ограничение нагрузки AI-процессов: до ~30% ресурсов сервера.

## 3. Целевое решение (high-level)

Компоненты:
1. `portal_auth`
- Yandex OAuth
- единый JWT (`auth_token`)

2. `kb_ring/api`
- ingest API
- search API (hybrid retrieval)
- chat API (`search|rag|analysis|rag-tech`)

3. `kb_ring/worker`
- chunking
- embeddings
- rerank
- NER
- jobs orchestration

4. `postgres + pgvector` (единая БД)
- схемы: `op`, `tac`, `chat`, `tg`

5. `TG Digest`
- источник данных и UI под `/tg`
- OCR + извлечение текста вложений

6. `transcription`
- генерация markdown-артефактов
- push результата в KB-RING (`/api/v1/ingest/transcript`)

## 4. Целевая модель данных

Обязательный слой KB-RING:
- `tac.documents` — единая сущность документа знаний
- `tac.chunks` — текстовые чанки и FTS
- `tac.embeddings` — pgvector (E5, 768)
- `chat.*` — сессии, сообщения, citations
- `op.jobs` — очередь обработки

Импортированный слой TG:
- схема `tg` содержит восстановленные таблицы/объекты TG
- затем ETL/материализация переводят данные TG в `tac.documents`

Правило канонического `uri`:
- TG: кликабельные ссылки через портал на одном домене
- transcription: ссылки под `/transcription/...` на том же домене

## 5. Интеграция источников

### 5.1 Transcription

Требования:
1. Принимает общий JWT (cookie/Authorization).
2. Сохраняет текущий quality pipeline (глоссарий + postprocess).
3. По завершении задачи публикует markdown в KB-RING ingest endpoint.
4. Передаёт `source_ref` и канонический `uri`.

Результат интеграции:
- документы transcription становятся обычными документами в `tac.documents`.

### 5.2 TG Digest

Требования:
1. На шаге 1 переносится «всё TG» в `kb_ring`.
2. Сохраняется рабочий контур TG после миграции.
3. Поддержка `/tg` через `root_path`/патчи web-части.
4. Вложения (минимум): `pdf`, `jpg/png`, `docx`, `txt/md/html`.

OCR политика:
- primary: cloud OCR из действующего TG-стека;
- fallback: локальный OCR;
- обработка последовательная (устойчивость, предсказуемая нагрузка).

## 6. Поиск и RAG

Retrieval pipeline:
1. FTS по `tac.chunks.tsv`.
2. Векторный поиск по `tac.embeddings`.
3. Объединение кандидатов и rerank.
4. Формирование top-k контекста.

Chat modes:
- `search` — retrieval only
- `rag` — ответ + citations
- `analysis` — аналитический отчёт + citations
- `rag-tech` — строгий инженерный формат + citations

Жёсткие ограничения:
- без citations ответ считается некорректным;
- контекст ограничен top-k чанками;
- индексация инкрементальная.

## 7. Нефункциональные требования

1. CPU-only стек на шаге 1 допускается.
2. На корпусе 10–50k документов поддерживается стабильная индексация.
3. Лимит ресурсов:
- docker resource limits для worker/api;
- ограничения параллелизма OCR/embeddings/rerank;
- целевой бюджет: до 30% host ресурсов.
4. Мониторинг обязателен (уровень Zabbix/netdata/аналог):
- host CPU/RAM/Disk
- postgres состояние
- API latency/error
- worker queue lag/error
- TG/transcription service health

## 8. Этапы реализации

### Этап 0: Локальная готовность

- Подготовить документы и скрипты миграции.
- Собрать и проверить локальный контур `db+api+worker`.
- Подготовить патчи subpath для TG/transcription.

### Этап 1: Тестовый контур на сервере Нила

- Развернуть KB-RING compose.
- Настроить единый домен и path routing.
- Импортировать TG в `kb_ring` (`tg` schema).
- Включить transcription push в ingest.
- Проверить поиск и `rag-tech` с citations.

### Этап 2: Усиление и стабилизация

- Довести ETL TG -> `tac.documents` до полного покрытия.
- Улучшить качество извлечения/ранжирования.
- Запустить метрики качества и производительности.

### Этап 3: Продовый cutover

- Переход на рабочий контур по утверждённому чеклисту.
- Ротация секретов и фиксация владельцев ключей.
- План отката и пост-деплой контроль.

## 9. Контрольные артефакты

Документы:
- `README.md`
- `docs/PLAN_STEP1_NIL_SERVER.md`
- `docs/DEPLOY_RU.md`
- `docs/LOCAL_AI_CPU_ONLY.md`
- `docs/ТРЕБОВАНИЯ_RAG.md`

Ops пакет:
- `ops/step1_nil/*`
- `server_exports/*`

## 10. Риски и меры

1. Риск: несовместимость TG web под `/tg`.
- Мера: запуск TG на Ниле в `/opt/tg_digest_system/` и точечный патч root path/frontend ссылок.

2. Риск: деградация OCR cloud API.
- Мера: последовательная очередь + fallback + retry/timeout.

3. Риск: превышение ресурсов при индексации.
- Мера: docker limits + batch control + поэтапная индексация.

4. Риск: потеря данных TG при миграции.
- Мера: `pg_dump -Fc`, контрольная проверка restore, хранение дампа и сопутствующих артефактов.

5. Риск: рассинхрон секретов между сервисами.
- Мера: единый серверный `secrets.env`, регламент ротации, журнал изменений.

## 11. Definition of Done (система в целом)

Система считается реализованной, когда:
1. Пользователь заходит через единый портал и получает доступ к разделам по subpath.
2. TG и transcription поставляют данные в единый слой знаний.
3. Поиск работает по объединённому корпусу данных.
4. `rag-tech` выдаёт инженерный ответ с корректными citations.
5. Мониторинг показывает контролируемую нагрузку и устойчивость сервисов.
6. Документация и runbook позволяют воспроизводимо развернуть систему на новом сервере.
